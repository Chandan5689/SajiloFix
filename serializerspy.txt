from rest_framework import serializers
from django.contrib.auth import get_user_model
from django.contrib.auth.password_validation import validate_password
from rest_framework.validators import UniqueValidator
from django.core.validators import RegexValidator
from .models import Speciality, Specialization, UserSpeciality, UserSpecialization, Certificate

User = get_user_model()


class SpecialitySerializer(serializers.ModelSerializer):
    """Serializer for Speciality model"""
    class Meta:
        model = Speciality
        fields = ['id', 'name', 'slug', 'description']


class SpecializationSerializer(serializers.ModelSerializer):
    """Serializer for Specialization model"""
    speciality_name = serializers.CharField(source='speciality.name', read_only=True)
    speciality = serializers.IntegerField(source='speciality.id', read_only=True)
    
    class Meta:
        model = Specialization
        fields = ['id', 'name', 'speciality', 'speciality_name']


class CertificateSerializer(serializers.ModelSerializer):
    """Serializer for Certificate model"""
    file_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Certificate
        fields = ['id', 'name', 'file', 'file_url', 'uploaded_at']
        read_only_fields = ['uploaded_at']
    
    def get_file_url(self, obj):
        if obj.file:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.file.url)
        return None




class UserSerializer(serializers.ModelSerializer):
    """Serializer for User model - used for profile display and updates"""
    specialities = serializers.SerializerMethodField()
    specializations = serializers.SerializerMethodField()
    certificates = CertificateSerializer(many=True, read_only=True)
    profile_picture_url = serializers.SerializerMethodField()
    citizenship_front_url = serializers.SerializerMethodField()
    citizenship_back_url = serializers.SerializerMethodField()
    full_name = serializers.SerializerMethodField()
    
    class Meta:
        model = User
        fields = (
            'id', 'email', 'username', 'first_name', 'last_name', 'full_name',
            'phone_number', 'user_type', 'profile_picture', 'profile_picture_url','location',
            'address', 'city', 'bio', 'business_name', 'years_of_experience',
            'service_area', 'is_verified', 'phone_verified', 
            'citizenship_front', 'citizenship_back', 'citizenship_front_url', 
            'citizenship_back_url', 'citizenship_number', 'citizenship_verified',
            'specialities', 'specializations', 'certificates', 'created_at', 'updated_at'
        )
        read_only_fields = ('id', 'username', 'email', 'is_verified', 'phone_verified', 'citizenship_verified', 'created_at', 'updated_at')
    
    def get_full_name(self, obj):
        """Return full name of the user"""
        return f"{obj.first_name} {obj.last_name}".strip()
    
    def get_profile_picture_url(self, obj):
        """Return absolute URL for profile picture"""
        if obj.profile_picture:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.profile_picture.url)
        return None
    
    def get_citizenship_front_url(self,obj):
        """Return absolute URL for citizenship front"""
        if obj.citizenship_front:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.citizenship_front.url)
        return None

    def get_citizenship_back_url(self, obj):
        """Return absolute URL for citizenship back"""
        if obj.citizenship_back:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.citizenship_back.url)
        return None


    def get_specialities(self, obj):
        """Get all specialities for the user"""
        user_specialities = UserSpeciality.objects.filter(user=obj).select_related('speciality')
        return [
            {
                'id': us.speciality.id,
                'name': us.speciality.name,
                'slug': us.speciality.slug
            }
            for us in user_specialities
        ]
    
    def get_specializations(self, obj):
        """Get all specializations for the user"""
        user_specializations = UserSpecialization.objects.filter(user=obj).select_related(
            'specialization', 'specialization__speciality'
        )
        return [
            {
                'id': us.specialization.id,
                'name': us.specialization.name,
                'speciality': us.specialization.speciality.name
            }
            for us in user_specializations
        ]