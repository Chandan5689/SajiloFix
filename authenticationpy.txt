import firebase_admin
from firebase_admin import auth as firebase_auth, credentials
from rest_framework import authentication, exceptions
from django.conf import settings
from django.contrib.auth import get_user_model
from .models import UserSpeciality, UserSpecialization
import os

User = get_user_model()

# Initialize Firebase Admin SDK
if not firebase_admin._apps:
    try:
        # Get BASE_DIR from settings
        BASE_DIR = getattr(settings, 'BASE_DIR', None)
        if not BASE_DIR:
            from pathlib import Path
            BASE_DIR = Path(__file__).resolve().parent.parent
        
        # Try to get service account path from environment or settings
        service_account_path = getattr(settings, 'FIREBASE_SERVICE_ACCOUNT_PATH', None)
        
        # If path is relative, make it relative to BASE_DIR
        if service_account_path:
            if not os.path.isabs(service_account_path):
                service_account_path = os.path.join(BASE_DIR, service_account_path)
            if os.path.exists(service_account_path):
                cred = credentials.Certificate(service_account_path)
                firebase_admin.initialize_app(cred)
                print(f"[FirebaseAuth] Firebase Admin SDK initialized successfully using: {service_account_path}")
            else:
                raise Exception(f"Firebase service account file not found at {service_account_path}")
        else:
            # Try default path (Backend/backend/firebase-service-account.json)
            default_path = os.path.join(BASE_DIR, 'firebase-service-account.json')
            if os.path.exists(default_path):
                cred = credentials.Certificate(default_path)
                firebase_admin.initialize_app(cred)
                print(f"[FirebaseAuth] Firebase Admin SDK initialized successfully using default path: {default_path}")
            else:
                raise Exception(f"Firebase service account file not found at {default_path}. BASE_DIR={BASE_DIR}")
    except Exception as e:
        print(f"[FirebaseAuth] ERROR: Firebase Admin initialization failed: {e}")
        print(f"[FirebaseAuth] BASE_DIR={BASE_DIR}")
        print("[FirebaseAuth] Make sure firebase-service-account.json exists in Backend/backend/ folder")
        # Don't raise here - let it fail when trying to verify tokens


class FirebaseAuthentication(authentication.BaseAuthentication):
    """
    Authenticate using Firebase ID tokens.
    Users must have email_verified=True and phone_number set to be considered fully authenticated.
    """
    
    def authenticate(self, request):
        auth_header = request.META.get('HTTP_AUTHORIZATION', '')
        
        if not auth_header:
            return None

        parts = auth_header.split()
        if len(parts) < 2 or parts[0].lower() != 'bearer':
            return None

        id_token = parts[1]
        
        try:
            # Verify Firebase ID token
            if not firebase_admin._apps:
                raise exceptions.AuthenticationFailed('Firebase Admin SDK not initialized. Check server logs.')
            
            decoded_token = firebase_auth.verify_id_token(id_token)
            
            uid = decoded_token.get('uid')
            email = decoded_token.get('email')
            email_verified = decoded_token.get('email_verified', False)
            phone_number = decoded_token.get('phone_number', '')
            name = decoded_token.get('name', '')
            
            if not uid or not email:
                raise exceptions.AuthenticationFailed('Invalid token: missing uid or email')
            
            # Extract first and last name from name field if available
            name_parts = name.split() if name else []
            first_name = name_parts[0] if len(name_parts) > 0 else ''
            last_name = ' '.join(name_parts[1:]) if len(name_parts) > 1 else ''
            
            # Get or create user in Django database
            user, created = User.objects.get_or_create(
                email=email,
                defaults={
                    'username': email.split('@')[0],
                    'first_name': first_name,
                    'last_name': last_name,
                    'is_active': True,
                    'phone_verified': False,  # Will be set to True after phone verification
                }
            )
            
            # Update Firebase UID if not set
            if not hasattr(user, 'firebase_uid') or not user.firebase_uid:
                # Add firebase_uid field if it doesn't exist (we'll handle this in migration)
                try:
                    user.firebase_uid = uid
                    user.save()
                except AttributeError:
                    # Field doesn't exist yet, will be added via migration
                    pass
            
            # Store phone number from Firebase if available and not already set
            if phone_number and not user.phone_number:
                # Remove country code if present (+977)
                clean_phone = phone_number.replace('+977', '').strip()
                if len(clean_phone) == 10 and (clean_phone.startswith('98') or clean_phone.startswith('97')):
                    user.phone_number = clean_phone
                    user.phone_verified = True  # If Firebase has phone, it's verified
                    user.save()
            
            # At this stage we only verify the token and link it to a Django user.
            # Whether the user has completed registration (email/phone/user_type)
            # is enforced at the view/permission layer using flags from /auth/me/.
            return (user, None)
        
        except firebase_auth.InvalidIdTokenError as e:
            print(f"[FirebaseAuthentication] InvalidIdTokenError: {e}")
            raise exceptions.AuthenticationFailed('Invalid Firebase token')
        except firebase_auth.ExpiredIdTokenError as e:
            print(f"[FirebaseAuthentication] ExpiredIdTokenError: {e}")
            raise exceptions.AuthenticationFailed('Firebase token has expired')
        except Exception as e:
            print(f"[FirebaseAuthentication] Exception: {type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()
            raise exceptions.AuthenticationFailed(f'Authentication failed: {str(e)}')

# Alias for backward compatibility / rename FirebaseAuthentication to ClerkAuthentication
ClerkAuthentication = FirebaseAuthentication